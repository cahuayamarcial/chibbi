<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.1.2/css/material-design-iconic-font.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="chibbi">
    <div class="chat-launcher">
      <p>Soporte</p>
    </div>
    <div class="chat-wrapper" style="display: none;">
      <div class="img-chibbi"> <img src="https://cahuayamarcial.github.io/chibbi/chibbi.png" alt=""> </div>
      <div class="header-chibbi">
        <h5>
          Chibbi
          <div class="online-chibbi"></div>
        </h5>
        <p id="firstMessage">Hola, ¿cómo te puedo ayudar? </p>
        <p id="returnMenu" style="display: none;"> <img src="https://cahuayamarcial.github.io/chibbi/return-menu.svg" alt=""> Regresar</p>
      </div>
      <div class="content-chibbi" id="sectionList">
        <div class="card-chibbi" title="Clic para ver más detalles" id="whatsapp">
          <div class="icon-one"> <img src="https://cahuayamarcial.github.io/chibbi/1.svg" alt=""> </div>
          <div class="cont">
            <h5>Chatea por WhatsApp</h5>
            <p>Ponte en contacto con un agente que solucionará tus dudas o problemas.</p>
          </div>
        </div>
        <div class="card-chibbi" title="Clic para ver más detalles" id="chatChibbi">
          <div class="icon-one"> <img src="https://cahuayamarcial.github.io/chibbi/2.svg" alt=""> </div>
          <div class="cont">
            <h5>Pregunta a Chibbi</h5>
            <p>Chibi puede responder tus preguntas en cualquier momento.</p>
          </div>
        </div>
        <div class="card-chibbi" title="Clic para ver más detalles" id="faqChibbi">
          <div class="icon-one"> <img src="https://cahuayamarcial.github.io/chibbi/3.svg" alt=""> </div>
          <div class="cont">
            <h5>Preguntas Frecuentes</h5>
            <p>Obtenga respuestas del campus fáciles de entender.</p>
          </div>
        </div>
      </div>
      <div class="content-chibbi conversation" id="sectionWhatsapp" style="display: none;">
        <div class="conversation-container">
          <div class="message-chibbi received"> <span id="random"></span> <span class="metadata"><span class="time"></span></span> </div>
        </div>
        <form class="conversation-compose">
          <div class="emoji"> </div>
          <input class="input-msg" name="input" placeholder="Escriba un mensaje aquí" autocomplete="off"> 
          <div class="photo"> </div>
          <button class="send">
            <div class="circle"> <i class="zmdi zmdi-mail-send"></i> </div>
          </button>
        </form>
      </div>
      <div class="content-chibbi chat-chibbi" id="sectionChibbiChat"style="display: none; height: 394px;padding: 0; margin: 0;">
        <div id="app">
          <div id="message-board">
          </div>
          <div id="form" class="bg-light">
            <div id="message" placeholder="Type your message here" rows="1" contenteditable></div>
            <div><button id="send" type="" class="btn-transparent btn-icon fas fa-paper-plane"></button></div>
          </div>
        </div>
      </div>
      <div class="content-chibbi faq-chibbi" id="sectionFaq"style="display: none;">
        <div class="faq-cont">
          <h5>No se mi usuario y contraseña</h5>
          <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Delectus optio beatae aliquid.</p>
        </div>
      </div>
    </div>
  </div>

  
  <div class="status-bar" style="display: none;">
    <div class="time"></div>
  </div>

  <script src='https://code.jquery.com/jquery-latest.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.11/vue.min.js"></script>
  <script src="script.js"></script>



  <script>
    $(document).ready(() => {


/******************/
/*** START CHAT ***/
/******************/


// set visitor name
let $userName = "Tom";

// start chatbox
$("#form-start").on("submit", (event) => {
  event.preventDefault();
  $userName = $("#username").val();
  $("#landing").slideUp(300);
  setTimeout(() => {
    $("#start-chat").html("Continue chat")
  }, 300);
});




/*****************/
/*** USER CHAT ***/
/*****************/


// Post a message to the board
function $postMessage() {
  $("#message").find("br").remove();
  let $message = $("#message").html().trim(); // get text from text box
  $message = $message.replace(/<div>/, "<br>").replace(/<div>/g, "").replace(/<\/div>/g, "<br>").replace(/<br>/g, " ").trim();
  if ($message) { // if text is not empty
    const html = `<div class="post post-user">${$message + timeStamp()}</span></div>`; // convert post to html
    $("#message-board").append(html); // add post to board
    $scrollDown(); // stay at bottom of chat
    botReply($message);
  };
  $("#message").empty();
};

// Chat input
$("#message").on("keyup", (event) => {
  if (event.which === 13) $postMessage(); // Use enter to send
}).on("focus", () => {
  $("#message").addClass("focus");
}).on("blur", () => {
  $("#message").removeClass("focus");
});
$("#send").on("click", $postMessage);




/**********************/
/*** AUTO REPLY BOT ***/
/**********************/


function botReply(userMessage) {
  const reply = generateReply(userMessage);
  if (typeof reply === "string") postBotReply(reply);
  else reply.forEach((str) => postBotReply(str));
};

function generateReply(userMessage) {
  
  const message = userMessage.toLowerCase();

  let reply = ""
  let defaultMessage = ['Ups, no he entendido a que te refieres.', '¿Podrías repetirlo, por favor?', '¿Disculpa?', '¿Decías?', '¿Cómo?', 'Lo siento, no logro entenderte 😔'];

  // Respuestas
  let intro = ["Hola!", "Hola 😊"];
  let love = ["Gracias! 😍", "Gracias, también te quiero", "Qué ternura", "😍"];


  // Generate some different replies
  if (/^hola$|^hola?a|^ola|^hey|^oli|^holas/.test(message)) reply = intro[Math.floor(Math.random() * intro.length)];
  else if (/test/.test(message)) reply = [`Ok`, `Feel free to test as much as you want`];
  else if (/help|sos|emergency|support/.test(message)) reply = [`I am here to help.`, `What seems to be the problem?`];
  else if (/class\=\"fa/.test(message)) reply = [`I see you've found the smileys`, `Cool! <span class="far fa-grin-beam fa-2x"></span>`, `Did you need something?`];
  else if (/how|what|why/.test(message)) reply = userMessage + " what?";
  else if (/^huh+|boring|lame|wtf|pff/.test(message)) reply = [`<span class="far fa-dizzy fa-2x"></span>`, `I'm sorry you feel that way`, `How can I make it better?`];
  else if (/como estas|ciao|adieu|salu/.test(message)) reply = [`Bien, gracias y tu?`];
  else if (/jeje|gg|jejeje|jajaja/.test(message)) reply = [`Es bueno sonreir`];
  else if (/bye|ciao|adieu|salu/.test(message)) reply = defaultMessage[Math.floor(Math.random() * intro.length)];
  else if (/te amo|te quiero/.test(message)) reply = love[Math.floor(Math.random() * intro.length)];
  else if (/oki|ok|oky|okay/.test(message)) reply = "Bueno, te puedo ayudar en algo más? 😃";
  else reply = defaultMessage[Math.floor(Math.random() * intro.length)];

  // if(message.includes('Hola')){
  // 	reply = [`Hi`]
  // 	// let finalresult = intro[Math.floor(Math.random() * intro.length)];
  // 	// speech.text = finalresult;
  // }

  // alert(message.includes('hola'))

  return reply;
};

function postBotReply(reply) {
  const html = `<div class="post post-bot">${reply + timeStamp()}</div>`;
  const timeTyping = 500 + Math.floor(Math.random() * 2000);
  $("#message-board").append(html);
  $scrollDown();
};



/******************/
/*** TIMESTAMPS ***/
/******************/


function timeStamp() {
  const timestamp = new Date();
  const hours = timestamp.getHours();
  let minutes = timestamp.getMinutes();
  if (minutes < 10) minutes = "0" + minutes;
  const html = `<span class="timestamp">${hours}:${minutes}</span>`;
  return html;
};




/***************/
/*** CHAT UI ***/
/***************/


// Back arrow button
$("#back-button").on("click", () => {
  $("#landing").show();
});


// Menu - navigation
$("#nav-icon").on("click", () => {
  $("#nav-container").show();
});

$("#nav-container").on("mouseleave", () => {
  $("#nav-container").hide();
});

$(".nav-link").on("click", () => {
  $("#nav-container").slideToggle(200);
});

// Clear history
$("#clear-history").on("click", () => {
  $("#message-board").empty();
  $("#message").empty();
});

// Sign out
$("#sign-out").on("click", () => {
  $("#message-board").empty();
  $("#message").empty();
  $("#landing").show();
  $("#username").val("");
  $("#start-chat").html("Start chat");
});




/*********************/
/*** SCROLL TO END ***/
/*********************/


function $scrollDown() {
  const $container = $("#message-board");
  const $maxHeight = $container.height();
  const $scrollHeight = $container[0].scrollHeight;
  if ($scrollHeight > $maxHeight) $container.scrollTop($scrollHeight);
}




/***************/
/*** EMOIJIS ***/
/***************/


// toggle emoijis
$("#emoi").on("click", () => {
  $("#emoijis").slideToggle(300);
  $("#emoi").toggleClass("fa fa-grin far fa-chevron-down");
});

// add emoiji to message
$(".smiley").on("click", (event) => {
  const $smiley = $(event.currentTarget).clone().contents().addClass("fa-lg");
  $("#message").append($smiley);
  $("#message").select(); // ==> BUG: message field not selected after adding smiley !! 
});





});


  </script>

</body>
</html>
